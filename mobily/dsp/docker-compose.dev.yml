# mobily/dsp/docker-compose.dev.yml
services:
  httpd:
    restart: always
    build:
      dockerfile: Dockerfile.dsp.dev
      context: ./httpd
    image:  mobily-dsp/httpd
    ports:                                  # HTTP & HTTPS ports, "HOST:CONTAINER"
      - '80:80'
      - '443:443'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/site.json" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - dsp-network

  # If you change a config file (i.e. service_proxies_config.json etc.
  # You'll need to run
  # docker exec -it a3gw-1 pm2 restart all
  a3gw:
    build:
      dockerfile: Dockerfile.dsp.dev
      context: ./a3gw
    environment:
      - NODE_ENV=development
    image: mobily-dsp/a3gw
    ports:
      - '8444:8444'
      - '8445:8445'
    volumes:
      - ./a3gw/src:/app/src
      - ./a3gw/dsp/conf.dev:/app/src/conf
      - ./a3gw/dsp/static.dev:/app/static
      - ./a3gw/dsp/ecosystem.config.js:/app/ecosystem.config.js
      - /app/node_modules
    networks:
      - dsp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8444/adminportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dspadminportal:
    build:
      dockerfile: Dockerfile.dev
      context: ./dsp-adminportal
    environment:
      - NODE_ENV=development
    image: mobily-dsp/dsp-adminportal
    ports:
      - '8080:8080'
    depends_on:
      - httpd
      - a3gw
    command: gulp server
    volumes:
      - ./dsp-adminportal/src:/space/app/src
      - ./dsp-adminportal/i18n:/space/app/i18n
      - ./dsp-adminportal/gulpfile.js:/space/app/gulpfile.js
      - ./dsp-adminportal/package.json:/space/app/package.json
      - ./dsp-adminportal/bower.json:/space/app/bower.json
      - ./dsp-adminportal/npm-shrinkwrap.original.json:/space/app/npm-shrinkwrap.original.json
      - ./dsp-adminportal/npm-shrinkwrap.original.json:/space/app/npm-shrinkwrap.json
      - /space/app/node_modules    # Prevent host node_modules overwrite
      - /space/app/bower_components
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8080/adminportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - dsp-network

  dspccportal:
    build:
      dockerfile: Dockerfile.dev
      context: ./dsp-ccportal
    environment:
      - NODE_ENV=development
    image: mobily-dsp/dsp-ccportal
    ports:
      - '8081:8081'
    depends_on:
      - httpd
      - a3gw
    command: gulp server
    volumes:
      - ./dsp-ccportal/src:/space/app/src
      - ./dsp-ccportal/i18n:/space/app/i18n
      - ./dsp-ccportal/gulpfile.js:/space/app/gulpfile.js
      - ./dsp-ccportal/package.json:/space/app/package.json
      - ./dsp-ccportal/bower.json:/space/app/bower.json
      - ./dsp-ccportal/npm-shrinkwrap.original.json:/space/app/npm-shrinkwrap.original.json
      - ./dsp-ccportal/npm-shrinkwrap.original.json:/space/app/npm-shrinkwrap.json
      - /space/app/node_modules
      - /space/app/bower_components
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8081/ccportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - dsp-network

  dsppartnerportal:
    build:
      dockerfile: Dockerfile.dev
      context: ./dsp-partnerportal
    environment:
      - NODE_ENV=development
    image: mobily-dsp/dsp-partnerportal
    ports:
      - '8082:8082'
    depends_on:
      - httpd
      - a3gw
    command: gulp server
    volumes:
      - ./dsp-partnerportal/src:/space/app/src
      - ./dsp-partnerportal/i18n:/space/app/i18n
      - ./dsp-partnerportal/gulpfile.js:/space/app/gulpfile.js
      - ./dsp-partnerportal/package.json:/space/app/package.json
      - ./dsp-partnerportal/bower.json:/space/app/bower.json
      - ./dsp-partnerportal/npm-shrinkwrap.original.json:/space/app/npm-shrinkwrap.original.json
      - ./dsp-partnerportal/npm-shrinkwrap.original.json:/space/app/npm-shrinkwrap.json
      - /space/app/node_modules
      - /space/app/bower_components
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8082/partnerportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - dsp-network

networks:
  dsp-network:
    driver: bridge


# Note: This file is used for development purposes only.
# HOW TO USE THIS FILE:
# docker-compose -f docker-compose.dev.yml up --build
# To run in detached mode:
# docker-compose -f docker-compose.dev.yml up --build -d
# To stop the containers:
# docker-compose -f docker-compose.dev.yml down
#
# ---------------------------------------------------
#
# To remove all stopped containers, networks, images, and volumes:
# docker-compose -f docker-compose.dev.yml down --rmi all --volumes --remove-orphans
# To force recreation of containers (complete clean start):
# docker compose -f docker-compose.dev.yml  up --build --force-recreate
#
# ---------------------------------------------------
#
# To rebuild the images without using cache:
# docker-compose -f docker-compose.dev.yml build --no-cache
# To view logs:
# docker-compose -f docker-compose.dev.yml logs -f
# To run a specific service:
# docker-compose -f docker-compose.dev.yml up --build <service_name>
