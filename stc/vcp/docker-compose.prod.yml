# stc/vcp/docker-compose.prod.yml
services:
  httpd:
    restart: always
    build:
      dockerfile: Dockerfile.vcp.prod
      context: ./httpd
    image:  stc-vcp/httpd
    ports:
      - '9080:80'
      - '9443:443'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/site.json" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - vcp-network

  # If you change a config file (i.e. service_proxies_config.json etc.
  # You'll need to run
  # docker exec -it a3gw-1 pm2 restart all
  a3gw:
    build:
      dockerfile: Dockerfile.vcp.prod
      context: ./a3gw
    # Comment out the registry image line for local builds
    # image: nexus.telenity.com/com/telenity/a3gw:1.0.9-main
    environment:
      - NODE_ENV=production
      - DOCKER_OPTS=--insecure-registry=nexus.telenity.com
    ports:
      - '8444:8444'
      - '8445:8445'
    depends_on:
      - httpd
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8444/adminportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Add platform for Apple Silicon compatibility
    platform: linux/arm64
    networks:
      - vcp-network

  vcpadminportal:
    build:
      dockerfile: Dockerfile.prod
      context: ./vcp-adminportal
    environment:
      - NODE_ENV=production
    image: stc-vcp/vcp-adminportal
    ports:
      - '8080:8080'
    depends_on:
      - httpd
      - a3gw
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8080/adminportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
    # Add platform for Apple Silicon compatibility
    platform: linux/arm64
    networks:
      - vcp-network

  vcpccportal:
    build:
      dockerfile: Dockerfile.prod
      context: ./vcp-ccportal
    environment:
      - NODE_ENV=production
    image: stc-vcp/vcp-ccportal
    ports:
      - '8081:8081'
    depends_on:
      - httpd
      - a3gw
    platform: linux/arm64
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8081/ccportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - vcp-network

  vcppartnerportal:
    build:
      dockerfile: Dockerfile.prod
      context: ./vcp-partnerportal
    environment:
      - NODE_ENV=production
    image: stc-vcp/vcp-partnerportal
    ports:
      - '8082:8082'
    depends_on:
      - httpd
      - a3gw
    platform: linux/arm64
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8082/partnerportal" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - vcp-network

# Add a network for service communication
networks:
  vcp-network:
    driver: bridge



# HOW TO USE THIS FILE:
# docker-compose -f docker-compose.prod.yml up --build
# To run in detached mode:
# docker-compose -f docker-compose.prod.yml up --build -d
# To stop the containers:
# docker-compose -f docker-compose.prod.yml down
#
# ---------------------------------------------------
#
# To remove all stopped containers, networks, images, and volumes:
# docker-compose -f docker-compose.prod.yml down --rmi all --volumes --remove-orphans
# To force recreation of containers (complete clean start):
# docker compose -f docker-compose.prod.yml  up --build --force-recreate
#
# ---------------------------------------------------
#
# To rebuild the images without using cache:
# docker-compose -f docker-compose.prod.yml build --no-cache
# To view logs:
# docker-compose -f docker-compose.prod.yml logs -f
# To run a specific service:
# docker-compose -f docker-compose.prod.yml up --build <service_name>
