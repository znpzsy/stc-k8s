apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: consolportals-sa-stc-vcp-ingress-alt
  annotations:
    # Session affinity
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "vcp-sticky"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "10800"
    nginx.ingress.kubernetes.io/session-cookie-expires: "10800"
    nginx.ingress.kubernetes.io/session-cookie-path: "/"
    nginx.ingress.kubernetes.io/session-cookie-samesite: "Lax"
    nginx.ingress.kubernetes.io/session-cookie-change-on-failure: "true"
    
    # Alternative security headers configuration
    # This version uses server-snippet instead of configuration-snippet
    # and doesn't rely on headers-more module
    nginx.ingress.kubernetes.io/server-snippet: |
      add_header X-Frame-Options "DENY" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header X-Download-Options "noopen" always;
      add_header X-Permitted-Cross-Domain-Policies "none" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Content-Security-Policy "default-src 'self' 'unsafe-eval' 'unsafe-inline' blob:; base-uri 'self'; form-action 'self'; frame-ancestors 'none';" always;
      
      # Note: Some headers like Feature-Policy may not work with standard add_header
      # For HTTPOnly cookie modification, this should be done at application level (a3gw)
    
    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    
    # Proxy settings
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    
    # Compression
    nginx.ingress.kubernetes.io/enable-compression: "true"
    
    # SSL
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
    
    # Rate limiting (optional)
    # nginx.ingress.kubernetes.io/limit-rps: "100"
    # nginx.ingress.kubernetes.io/limit-connections: "10"
    
    # Custom error pages (optional)
    # nginx.ingress.kubernetes.io/custom-http-errors: "404,503"
    # nginx.ingress.kubernetes.io/default-backend: custom-error-pages
    
spec:
  ingressClassName: nginx
  # Uncomment for TLS
  # tls:
  #   - hosts:
  #       - your-domain.com
  #     secretName: vcp-tls-secret
  rules:
    - http:
        paths:
          # Auth endpoints - direct to a3gw port 8445
          - pathType: Prefix
            path: "/cmpf-auth-rest/refresh-token"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8445
          
          - pathType: Prefix
            path: "/cmpf-auth-rest"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8445
          
          - pathType: Prefix
            path: "/img/captcha.png"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8445
          
          # Portal endpoints - to a3gw port 8444
          - pathType: Prefix
            path: "/adminportal"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8444
          
          - pathType: Prefix
            path: "/ccportal"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8444
          
          - pathType: Prefix
            path: "/partnerportal"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8444
          
          # Other services
          - pathType: Prefix
            path: "/vcp/services"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8444
          
          - pathType: Prefix
            path: "/conf"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8444
          
          - pathType: Prefix
            path: "/site.json"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8444
          
          # Default - everything else goes to a3gw port 8444
          - pathType: Prefix
            path: "/"
            backend:
              service:
                name: consolportals-sa-stc-vcp-a3gw-service
                port:
                  number: 8444

---

# Optional: ConfigMap for NGINX Ingress Controller custom settings
# Apply this if you need to customize global Ingress behavior
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-configuration
  namespace: ingress-nginx
data:
  # Custom log format
  log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id'
  
  # Enable real IP (important if behind load balancer)
  use-forwarded-headers: "true"
  compute-full-forwarded-for: "true"
  
  # SSL settings
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
  
  # Performance tuning
  keep-alive: "75"
  keep-alive-requests: "100"
  upstream-keepalive-connections: "50"
  
  # Body size limits
  proxy-body-size: "10m"
  
  # Timeouts
  proxy-connect-timeout: "300"
  proxy-read-timeout: "300"
  proxy-send-timeout: "300"
  
  # Hide server tokens
  server-tokens: "false"
  
  # Enable compression
  use-gzip: "true"
  gzip-level: "5"
  gzip-types: "application/atom+xml application/javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/javascript text/plain text/x-component"

---

# Optional: External authentication configuration
# Uncomment if you need to add authentication at Ingress level
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: consolportals-auth-ingress
#   annotations:
#     nginx.ingress.kubernetes.io/auth-url: "http://auth-service.default.svc.cluster.local/auth"
#     nginx.ingress.kubernetes.io/auth-signin: "https://your-domain.com/login"
#     nginx.ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User,X-Auth-Request-Email"
# spec:
#   ingressClassName: nginx
#   rules:
#     - host: your-domain.com
#       http:
#         paths:
#           - path: /adminportal
#             pathType: Prefix
#             backend:
#               service:
#                 name: consolportals-sa-stc-vcp-a3gw-service
#                 port:
#                   number: 8444

---

# Optional: Custom error pages service
# apiVersion: v1
# kind: Service
# metadata:
#   name: custom-error-pages
# spec:
#   selector:
#     app: custom-error-pages
#   ports:
#     - port: 80
#       targetPort: 8080
